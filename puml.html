<!-- 
============================================
// src/puml.html
============================================
Author: Erez Kalman - KSEC
This project is licensed under a custom Personal Non-Commercial Use License:
Free for personal, private, non-commercial use only.
Code can be reused under these same terms, provided that:
The software remains open source and freely available.
Commercial ownership and rights are retained exclusively by the author (Erez Kalman - KSEC).
Any commercial use, redistribution for profit, or inclusion in proprietary commercial software is strictly prohibited without prior written consent from the author.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUML - Local Forge</title>
    <style>
        :root {
            --bg-main: #f3f3f3;
            --bg-panel: #ffffff;
            --bg-header: #e0e0e0;
            --bg-input: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --accent: #007acc;
            --accent-hover: #005a9e;
            --border: #cccccc;
            --success: #2e7d32;
            --danger: #d32f2f;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Layout */
        header {
            background-color: var(--bg-header);
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            height: 40px;
            flex-shrink: 0;
        }

        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-panel);
            position: relative;
        }

        .pane-left {
            border-right: 1px solid var(--border);
        }

        .pane-header {
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            height: 36px;
        }

        .pane-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-right: auto;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        textarea {
            flex: 1;
            background-color: var(--bg-input);
            color: var(--text-main);
            border: none;
            padding: 1rem;
            resize: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
        }

        /* Preview Area */
        .preview-viewport {
            flex: 1;
            overflow: auto; 
            background-color: #f0f0f0;
            background-image: linear-gradient(45deg, #e5e5e5 25%, transparent 25%), linear-gradient(-45deg, #e5e5e5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e5e5e5 75%), linear-gradient(-45deg, transparent 75%, #e5e5e5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .preview-content {
            transform-origin: 0 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background: white; 
        }

        .preview-content img, .preview-content svg {
            display: block;
        }
        
        /* Iframe for ASCII Fallback */
        .preview-content iframe {
            display: block;
            border: none;
            background: white;
            width: 100%;
            height: 100%;
            min-width: 400px; /* basic sizing */
            min-height: 400px;
        }
        
        .status-bar {
            background-color: var(--bg-header);
            padding: 0.25rem 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
            align-items: center;
            height: 30px;
            justify-content: flex-end; 
        }

        /* Toast Notification (Prominent, Top) */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            font-weight: 600;
            font-size: 0.95rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }

        /* Components */
        button, .button-like {
            background-color: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 0 0.6rem; 
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 28px;
            text-decoration: none;
            box-sizing: border-box;
            line-height: 1;
        }

        button:hover, .button-like:hover {
            background-color: #e6e6e6;
            border-color: #999;
        }

        button.primary {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        button.primary:hover {
            background-color: var(--accent-hover);
        }
        
        button.danger {
            color: var(--danger);
            border-color: var(--danger);
        }
        button.danger:hover {
            background: #ffebeb;
        }

        /* Split Button */
        .split-btn {
            display: flex;
            align-items: center;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 3px;
            background: var(--bg-input);
            position: relative; 
            height: 28px;
            box-sizing: border-box;
        }
        .split-btn button {
            border: none;
            background: transparent;
            height: 26px; /* -2px for border */
            border-radius: 0;
            margin: 0;
        }
        .split-btn button:first-child {
            border-right: 1px solid var(--border);
            padding: 0 8px;
        }
        .split-btn button.arrow {
            padding: 0 4px;
        }
        .split-btn:hover { border-color: #999; }
        .split-btn button:hover { background-color: #e6e6e6; }

        select, input[type="text"], input[type="password"] {
            background-color: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.85rem;
            height: 28px;
            box-sizing: border-box;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-panel);
            width: 80%;
            height: 80%;
            max-width: 900px;
            border: 1px solid var(--border);
            border-radius: 5px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .modal.small-modal {
            width: 400px;
            height: auto;
            max-height: 300px;
        }

        .modal-header {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            background: var(--bg-header);
        }

        .modal-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 0.8rem 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--bg-main);
        }

        /* List styles */
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .item-list li {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 8px 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 3px;
        }
        .item-list li:hover {
            border-color: var(--accent);
        }

        /* Dropdown Menu (Custom) */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            flex-direction: column;
            min-width: 140px;
            border-radius: 3px;
            margin-top: 2px;
            padding: 0;
        }
        .dropdown-menu.active { display: flex; }
        .dropdown-menu button {
            border: none;
            border-bottom: 1px solid #eee;
            text-align: left;
            justify-content: flex-start;
            padding: 8px 12px;
            background: white;
            border-radius: 0;
            width: 100%;
            height: 32px;
            margin: 0;
        }
        .dropdown-menu button:last-child { border-bottom: none; }
        .dropdown-menu button:hover { background: #f5f5f5; }

        /* Util */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; gap: 10px; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .section-title { font-size: 0.8rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin: 15px 0 5px 0; }
        
        svg { width: 16px; height: 16px; fill: currentColor; }
        .icon-btn { padding: 0; width: 28px; justify-content: center; }
    </style>
</head>
<body>

    <header>
        <div class="flex-row">
            <svg viewBox="0 0 24 24" style="color:var(--accent);"><path d="M3 3h18v18H3V3m2 2v14h14V5H5m4 4h6v2H9V9m0 4h6v2H9v-2z"/></svg>
            <span style="font-weight:bold;">PUML Local Forge</span>
        </div>
        
        <div class="flex-row">
            <select id="service-select" style="width: 200px;">
                <!-- Populated by JS -->
            </select>
            <button id="btn-manage-services" title="Manage Services" class="icon-btn">
                <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
            <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
            <button id="btn-decode-modal" title="Decode encoded string" class="primary">
                Decode
            </button>
        </div>
    </header>

    <div class="workspace">
        <!-- Editor Pane -->
        <div class="pane pane-left">
            <div class="pane-header">
                <span class="pane-title">Editor</span>
                <button id="btn-storage" title="Storage" class="icon-btn">
                     <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                </button>
                <div style="width:1px; height:20px; background:var(--border);"></div>
                <button id="btn-copy-source" title="Copy Source" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/></svg></button>
                <button id="btn-dl-source" title="Download Editor" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2m14-9h-4V3H9v8H5l7 7 7-7z"/></svg></button>
                <label for="file-upload" class="button-like icon-btn" title="Upload to Editor">
                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6m-4 2h14v2H5v-2z"/></svg>
                </label>
                <input id="file-upload" type="file" class="hidden" accept=".puml,.plantuml,.txt">
            </div>
            <textarea id="editor" spellcheck="false" placeholder="@startuml&#10;Alice -> Bob: Hello&#10;@enduml">@startuml
Alice -> Bob: Hello
Bob --> Alice: Hi there
@enduml</textarea>
        </div>

        <!-- Preview Pane -->
        <div class="pane pane-right">
            <div class="pane-header">
                <span class="pane-title">Preview</span>
                
                <div class="flex-row">
                    <!-- Format Selector -->
                    <select id="preview-fmt-select" title="Preview Format" style="width:70px;">
                        <option value="png">PNG</option>
                        <option value="svg">SVG</option>
                        <option value="txt">ASCII</option>
                    </select>
                    
                    <button id="btn-manage-config" title="Configs" class="icon-btn">
                        <svg viewBox="0 0 24 24"><path d="M19,15H7c-1.1,0-2-0.9-2-2s0.9-2,2-2h12c1.1,0,2,0.9,2,2S20.1,15,19,15z M7,13c-0.55,0-1,0.45-1,1s0.45,1,1,1h12 c0.55,0,1-0.45,1-1s-0.45-1-1-1H7z M7,9h12c1.1,0,2-0.9,2-2s-0.9-2-2-2H7C5.9,5,5,5.9,5,7S5.9,9,7,9z M7,7h12c0.55,0,1,0.45,1,1 s-0.45,1-1,1H7C6.45,9,6,8.55,6,8S6.45,7,7,7z M19,21H7c-1.1,0-2-0.9-2-2s0.9-2,2-2h12c1.1,0,2,0.9,2,2S20.1,21,19,21z M7,19 c-0.55,0-1,0.45-1,1s0.45,1,1,1h12c0.55,0,1-0.45,1-1s-0.45-1-1-1H7z"/></svg>
                    </button>

                    <div style="width:1px; height:20px; background:var(--border);"></div>

                    <!-- Zoom Controls -->
                    <button id="btn-zoom-out" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5m-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14M7 9h5v1H7"/></svg></button>
                    <button id="btn-zoom-reset" style="font-size:0.7rem; padding:0 4px; min-width:36px;">100%</button>
                    <button id="btn-zoom-in" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5m-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/></svg></button>
                    
                    <div style="width:1px; height:20px; background:var(--border);"></div>

                    <!-- Copy Split Button -->
                    <div class="split-btn">
                        <button id="btn-copy-main">Copy PNG</button>
                        <button class="arrow" id="btn-copy-arrow">▼</button>
                        <div id="menu-copy" class="dropdown-menu">
                            <button data-fmt="png">Copy PNG</button>
                            <button data-fmt="svg-image">Copy SVG (Image)</button>
                            <button data-fmt="svg">Copy SVG (Code)</button>
                            <button data-fmt="txt">Copy ASCII</button>
                        </div>
                    </div>

                    <!-- Download Split Button -->
                    <div class="split-btn">
                        <button id="btn-dl-main">Save PNG</button>
                        <button class="arrow" id="btn-dl-arrow">▼</button>
                        <div id="menu-dl" class="dropdown-menu">
                            <button data-fmt="png">Save PNG</button>
                            <button data-fmt="svg">Save SVG</button>
                            <button data-fmt="txt">Save ASCII</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="preview-viewport" class="preview-viewport">
                <div id="preview-content" class="preview-content">
                    <!-- Content injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">Notification</div>

    <!-- Storage Modal -->
    <div id="modal-storage" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>Storage</span>
                <button class="close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="flex-col">
                    <div class="flex-row">
                        <input type="text" id="save-name-input" placeholder="Diagram Name" style="flex:1;">
                        <button id="btn-modal-save" class="primary">Save</button>
                    </div>
                    <div class="section-title">Library</div>
                    <ul id="diagram-list" class="item-list">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-export-db">Export DB (JSON)</button>
                <button id="btn-import-db">Import DB (JSON)</button>
                <input type="file" id="import-db-file" class="hidden" accept=".json">
            </div>
        </div>
    </div>

    <!-- Service Manager Modal -->
    <div id="modal-services" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>Manage Services</span>
                <button class="close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="flex-col">
                    <div class="section-title">Add / Edit Service</div>
                    <div class="flex-col" style="background:#f9f9f9; padding:10px; border:1px solid var(--border);">
                        <input type="text" id="svc-name" placeholder="Service Name (e.g. My Local)">
                        <input type="text" id="svc-url" placeholder="URL Base (e.g. http://localhost:8080/plantuml)">
                        <label style="display:flex; align-items:center; gap:5px; margin-top:5px; font-size:0.8rem;">
                            <input type="checkbox" id="chk-svc-auth"> Requires Bearer Token
                        </label>
                        <input type="password" id="svc-token" placeholder="Bearer Token" class="hidden" style="margin-top:5px;">
                        <div class="flex-row" style="justify-content:flex-end; margin-top:5px;">
                            <button id="btn-svc-clear">Clear</button>
                            <button id="btn-svc-save" class="primary">Save Service</button>
                        </div>
                    </div>
                    
                    <div class="section-title">Available Services</div>
                    <ul id="service-list" class="item-list">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-svc-export">Export (JSON)</button>
                <button id="btn-svc-import">Import (JSON)</button>
                <input type="file" id="import-svc-file" class="hidden" accept=".json">
                <div style="flex:1"></div>
                <button id="btn-svc-reset-defaults">Reset to Defaults</button>
            </div>
        </div>
    </div>
    
    <!-- Config Manager Modal -->
    <div id="modal-config" class="modal-overlay">
        <div class="modal small-modal">
            <div class="modal-header">
                <span>Preview Configuration</span>
                <button class="close-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="flex-col">
                    <label>Default Preview Format:</label>
                    <select id="cfg-def-fmt">
                        <option value="png">PNG</option>
                        <option value="svg">SVG</option>
                        <option value="txt">ASCII</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-cfg-save" class="primary">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Decode Modal -->
    <div id="modal-decode" class="modal-overlay">
        <div class="modal small-modal">
            <div class="modal-header">
                <span>Decode PlantUML URL</span>
                <button class="close-modal">✕</button>
            </div>
            <div class="modal-body">
                <p>Paste the encoded string (part after /png/ or /svg/).</p>
                <input type="text" id="decode-input" placeholder="e.g. SyfFKj2r..." style="width:100%;">
            </div>
            <div class="modal-footer">
                <button id="btn-run-decode" class="primary">Decode to Editor</button>
            </div>
        </div>
    </div>
    
    <!-- Input Modal (Replacement for Prompt) -->
    <div id="modal-input" class="modal-overlay">
        <div class="modal small-modal">
            <div class="modal-header">
                <span id="input-title">Enter Value</span>
            </div>
            <div class="modal-body">
                <input type="text" id="input-val" style="width:100%;">
            </div>
            <div class="modal-footer">
                <button id="btn-input-cancel">Cancel</button>
                <button id="btn-input-ok" class="primary">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal small-modal">
            <div class="modal-header">
                <span>Confirm Action</span>
            </div>
            <div class="modal-body">
                <p id="confirm-msg">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button id="btn-confirm-no">Cancel</button>
                <button id="btn-confirm-yes" class="danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // ==========================================
        // 1. COMPRESSION UTILS (Raw Inflate - Complete)
        // ==========================================
        const Compression = (function() {
            function deflate(payload) {
                const textEnc = new TextEncoder();
                const raw = textEnc.encode(payload);
                const chunks = [];
                let pos = 0;
                while(pos < raw.length) {
                    const len = Math.min(raw.length - pos, 65535);
                    const isLast = (pos + len === raw.length);
                    const header = isLast ? 0x01 : 0x00; 
                    const block = new Uint8Array(5 + len);
                    block[0] = header; 
                    block[1] = len & 0xFF; block[2] = (len >> 8) & 0xFF;
                    block[3] = (~len) & 0xFF; block[4] = ((~len) >> 8) & 0xFF;
                    block.set(raw.subarray(pos, pos + len), 5);
                    chunks.push(block);
                    pos += len;
                }
                if(raw.length === 0) return new Uint8Array([0x01, 0x00, 0x00, 0xFF, 0xFF]);
                const total = chunks.reduce((acc, c) => acc + c.length, 0);
                const res = new Uint8Array(total);
                let off = 0;
                for(let c of chunks) { res.set(c, off); off += c.length; }
                return res;
            }

            // Compact INFLATE (Uncompressed, Fixed, Dynamic)
            function inflate(data) {
                var buf = new Uint8Array(data.length * 5), bufPtr = 0; 
                var bits = 0, bitLen = 0, dataPtr = 0;
                
                function read(len) {
                    while (bitLen < len) {
                        if (dataPtr >= data.length) throw "EOF";
                        bits |= data[dataPtr++] << bitLen;
                        bitLen += 8;
                    }
                    var val = bits & ((1 << len) - 1);
                    bits >>>= len; bitLen -= len;
                    return val;
                }
                
                function readCode(lens) {
                    var count = new Uint16Array(16), next = new Uint16Array(16);
                    for (var i = 0; i < lens.length; i++) count[lens[i]]++;
                    var code = 0; count[0] = 0;
                    for (var i = 1; i <= 15; i++) { code = (code + count[i-1]) << 1; next[i] = code; }
                    
                    var keys = {}; 
                    for(var i=0; i<lens.length; i++) if(lens[i]) keys[(lens[i]<<16)|next[lens[i]]++] = i;
                    
                    var curLen = 1, curCode = read(1);
                    while(true) {
                       var k = (curLen<<16) | curCode;
                       if(keys[k] !== undefined) return keys[k];
                       curCode = (curCode<<1) | read(1);
                       curLen++;
                    }
                }

                while (true) {
                    var bfinal = read(1);
                    var btype = read(2);
                    
                    if (btype === 0) { // Uncompressed
                        bits = 0; bitLen = 0; 
                        var len = data[dataPtr] | (data[dataPtr+1]<<8);
                        var nlen = data[dataPtr+2] | (data[dataPtr+3]<<8);
                        dataPtr += 4;
                        for(var i=0; i<len; i++) buf[bufPtr++] = data[dataPtr++];
                    } 
                    else {
                        var litlen, dist;
                        if(btype === 1) { // Fixed
                            litlen = new Uint8Array(288);
                            for(var i=0; i<=143; i++) litlen[i]=8;
                            for(var i=144; i<=255; i++) litlen[i]=9;
                            for(var i=256; i<=279; i++) litlen[i]=7;
                            for(var i=280; i<=287; i++) litlen[i]=8;
                            dist = new Uint8Array(32); for(var i=0;i<32;i++) dist[i]=5;
                        } else { // Dynamic
                            var hlit = read(5)+257, hdist = read(5)+1, hclen = read(4)+4;
                            var clen = new Uint8Array(19);
                            var order = [16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];
                            for(var i=0; i<hclen; i++) clen[order[i]] = read(3);
                            
                            var litlen = new Uint8Array(hlit + hdist), ptr=0;
                            while(ptr < hlit + hdist) {
                                var sym = readCode(clen);
                                if(sym < 16) litlen[ptr++] = sym;
                                else if(sym === 16) { var l=read(2)+3, p=litlen[ptr-1]; while(l--) litlen[ptr++]=p; }
                                else if(sym === 17) { var l=read(3)+3; while(l--) litlen[ptr++]=0; }
                                else { var l=read(7)+11; while(l--) litlen[ptr++]=0; }
                            }
                            dist = litlen.slice(hlit);
                            litlen = litlen.slice(0, hlit);
                        }
                        
                        while(true) {
                            var sym = readCode(litlen);
                            if(sym === 256) break;
                            if(sym < 256) buf[bufPtr++] = sym;
                            else {
                                var lenCode = sym - 257;
                                var lenExtra = (lenCode>=8 && lenCode<28) ? ((lenCode-4)>>2) : 0;
                                if(lenCode===28) lenExtra=0; 
                                var matchLen;
                                var base = [3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];
                                var extra = [0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];
                                matchLen = base[lenCode] + read(extra[lenCode]);
                                
                                var distCode = readCode(dist);
                                var dBase = [1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];
                                var dExtra = [0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];
                                var matchDist = dBase[distCode] + read(dExtra[distCode]);
                                
                                for(var i=0; i<matchLen; i++) buf[bufPtr] = buf[bufPtr - matchDist], bufPtr++;
                            }
                        }
                    }
                    if (bfinal) break;
                }
                return buf.slice(0, bufPtr);
            }
            return { deflate, inflate };
        })();

        // ==========================================
        // 2. PLANTUML ENCODING
        // ==========================================
        const PlantEncoder = (function() {
            const A = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
            function encode64(data) {
                let r = "";
                for (let i = 0; i < data.length; i += 3) {
                    let b1 = data[i], b2 = (i+1<data.length)?data[i+1]:0, b3 = (i+2<data.length)?data[i+2]:0;
                    let c1 = b1 >> 2;
                    let c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                    let c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                    let c4 = b3 & 0x3F;
                    r += A[c1&0x3F] + A[c2&0x3F] + A[c3&0x3F] + A[c4&0x3F];
                }
                return r;
            }
            function decode64(str) {
                let d = [];
                for(let i=0; i<str.length; i+=4) {
                    let c1=A.indexOf(str.charAt(i));
                    let c2=A.indexOf(str.charAt(i+1));
                    let c3=A.indexOf(str.charAt(i+2)); 
                    let c4=A.indexOf(str.charAt(i+3)); 
                    if(c1<0 || c2<0) break; 
                    d.push((c1 << 2) | ((c2 & 0x30) >> 4));
                    if(c3 >= 0) {
                        d.push(((c2 & 0x0F) << 4) | ((c3 & 0x3C) >> 2));
                        if(c4 >= 0) d.push(((c3 & 0x03) << 6) | c4);
                    }
                }
                return new Uint8Array(d);
            }
            return {
                encode: (text) => encode64(Compression.deflate(text)),
                decode: async (str) => {
                    try {
                        const bytes = decode64(str);
                        
                        // Priority 1: Native DecompressionStream (Fastest)
                        if (typeof DecompressionStream !== 'undefined') {
                            try {
                                const ds = new DecompressionStream('deflate-raw');
                                const writer = ds.writable.getWriter();
                                await writer.write(bytes);
                                await writer.close();
                                const blob = await new Response(ds.readable).blob();
                                return await blob.text();
                            } catch(e) {
                                // Swallow native error and try fallback
                            }
                        }
                        
                        // Priority 2: Robust Manual Inflate
                        const simple = Compression.inflate(bytes);
                        return new TextDecoder().decode(simple);

                    } catch(e) { 
                        return "Error: Could not decode. " + e;
                    }
                }
            };
        })();

        // ==========================================
        // 3. DATABASE
        // ==========================================
        class DB {
            constructor() { this.dbName = 'puml_db'; this.version = 1; this.db = null; }
            async connect() {
                if(this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const r = indexedDB.open(this.dbName, this.version);
                    r.onupgradeneeded = (e) => {
                        const d = e.target.result;
                        if(!d.objectStoreNames.contains('config')) d.createObjectStore('config', { keyPath: 'key' });
                        if(!d.objectStoreNames.contains('diagrams')) d.createObjectStore('diagrams', { keyPath: 'name' });
                        if(!d.objectStoreNames.contains('services')) d.createObjectStore('services', { keyPath: 'name' });
                    };
                    r.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                    r.onerror = (e) => reject(e);
                });
            }
            async op(store, mode, fn) {
                await this.connect();
                return new Promise((res, rej) => {
                    const tx = this.db.transaction(store, mode);
                    const req = fn(tx.objectStore(store));
                    req.onsuccess = () => res(req.result);
                    req.onerror = () => rej(req.error);
                });
            }
            async get(s, k) { return this.op(s, 'readonly', st => st.get(k)); }
            async getAll(s) { return this.op(s, 'readonly', st => st.getAll()); }
            async put(s, v) { return this.op(s, 'readwrite', st => st.put(v)); }
            async delete(s, k) { return this.op(s, 'readwrite', st => st.delete(k)); }
            
            async exportAll() {
                const c = await this.getAll('config');
                const d = await this.getAll('diagrams');
                const s = await this.getAll('services');
                return JSON.stringify({ version:7, config:c, diagrams:d, services:s }, null, 2);
            }
            async importAll(json) {
                try {
                    const d = JSON.parse(json);
                    if(d.config) for(let i of d.config) await this.put('config', i);
                    if(d.diagrams) for(let i of d.diagrams) await this.put('diagrams', i);
                    if(d.services) for(let i of d.services) await this.put('services', i);
                    return true;
                } catch(e) { console.error(e); return false; }
            }
        }
        const db = new DB();

        // ==========================================
        // 4. APP CONTROLLER
        // ==========================================
        const app = {
            state: {
                svcUrl: 'https://www.plantuml.com/plantuml',
                previewFmt: 'png',
                copyFmt: 'png',
                dlFmt: 'png',
                zoom: 1.0,
                encoded: '',
                docName: 'Untitled',
                currentPreviewBlobUrl: null
            },
            
            async init() {
                const defs = [
                    { name: 'PlantUML (Online)', url: 'https://www.plantuml.com/plantuml' },
                    { name: 'Local (Port 8080)', url: 'http://127.0.0.1:8080/plantuml' }
                ];
                const existing = await db.getAll('services');
                if(existing.length === 0) for(let s of defs) await db.put('services', s);

                const cfg = await db.get('config', 'settings');
                if(cfg) {
                    this.state.svcUrl = cfg.svcUrl || this.state.svcUrl;
                    this.state.previewFmt = cfg.previewFmt || 'png';
                }
                document.getElementById('preview-fmt-select').value = this.state.previewFmt;
                document.getElementById('cfg-def-fmt').value = this.state.previewFmt;

                const draft = await db.get('config', 'draft');
                if(draft) document.getElementById('editor').value = draft.val;

                this.renderServices();
                this.bindEvents();
                this.update();
            },

            async renderServices() {
                const list = await db.getAll('services');
                const sel = document.getElementById('service-select');
                sel.innerHTML = '';
                list.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.url;
                    opt.textContent = s.name;
                    if(s.url === this.state.svcUrl) opt.selected = true;
                    sel.appendChild(opt);
                });
            },

            bindEvents() {
                const editor = document.getElementById('editor');
                let t;
                editor.addEventListener('input', () => {
                    clearTimeout(t);
                    t = setTimeout(() => {
                        db.put('config', { key:'draft', val:editor.value });
                        this.update();
                    }, 500);
                });

                document.getElementById('service-select').addEventListener('change', (e) => {
                    this.state.svcUrl = e.target.value;
                    this.saveConfig();
                    this.update();
                });
                
                document.getElementById('preview-fmt-select').addEventListener('change', (e) => {
                    this.state.previewFmt = e.target.value;
                    this.update();
                });

                document.getElementById('btn-manage-services').onclick = () => this.openServicesModal();
                document.getElementById('btn-manage-config').onclick = () => document.getElementById('modal-config').classList.add('active');
                
                document.getElementById('btn-cfg-save').onclick = () => {
                    this.state.previewFmt = document.getElementById('cfg-def-fmt').value;
                    document.getElementById('preview-fmt-select').value = this.state.previewFmt;
                    this.saveConfig();
                    document.getElementById('modal-config').classList.remove('active');
                    this.update();
                };

                document.getElementById('btn-decode-modal').onclick = () => document.getElementById('modal-decode').classList.add('active');
                
                // DECODE LOGIC FIX
                document.getElementById('btn-run-decode').onclick = async () => {
                    const inp = document.getElementById('decode-input');
                    const val = inp.value.trim();
                    if(!val) return;
                    const res = await PlantEncoder.decode(val);
                    
                    if (res && res.startsWith("Error:")) {
                        this.toast(res);
                    } else {
                        editor.value = res;
                        this.update();
                        document.getElementById('modal-decode').classList.remove('active');
                        inp.value = ''; // Clear input on success
                    }
                };

                const applyTransform = () => {
                    document.getElementById('preview-content').style.transform = `scale(${this.state.zoom})`;
                };
                document.getElementById('btn-zoom-in').onclick = () => { this.state.zoom += 0.1; applyTransform(); document.getElementById('btn-zoom-reset').textContent = Math.round(this.state.zoom*100)+'%'; };
                document.getElementById('btn-zoom-out').onclick = () => { this.state.zoom = Math.max(0.1, this.state.zoom - 0.1); applyTransform(); document.getElementById('btn-zoom-reset').textContent = Math.round(this.state.zoom*100)+'%'; };
                document.getElementById('btn-zoom-reset').onclick = () => { this.state.zoom = 1; applyTransform(); document.getElementById('btn-zoom-reset').textContent = '100%'; };

                const setupSplit = (btnId, menuId, actionFn, mainId, stateKey) => {
                    const btn = document.getElementById(btnId);
                    const menu = document.getElementById(menuId);
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.dropdown-menu').forEach(m => { if(m!==menu) m.classList.remove('active'); });
                        menu.classList.toggle('active');
                    };
                    document.getElementById(mainId).onclick = () => actionFn(this.state[stateKey]);
                    menu.querySelectorAll('button').forEach(b => {
                        b.onclick = () => {
                            const f = b.dataset.fmt;
                            actionFn(f);
                            menu.classList.remove('active');
                        };
                    });
                };
                setupSplit('btn-copy-arrow', 'menu-copy', (f) => this.handleCopy(f), 'btn-copy-main', 'copyFmt');
                setupSplit('btn-dl-arrow', 'menu-dl', (f) => this.handleDownload(f), 'btn-dl-main', 'dlFmt');
                
                window.onclick = (e) => { if(!e.target.closest('.split-btn')) document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active')); };

                document.querySelectorAll('.close-modal').forEach(b => b.onclick = (e) => e.target.closest('.modal-overlay').classList.remove('active'));
                document.querySelectorAll('.modal-overlay').forEach(m => m.onclick = (e) => { if(e.target===m) m.classList.remove('active'); });

                document.getElementById('btn-storage').onclick = () => { this.loadStorageList(); document.getElementById('modal-storage').classList.add('active'); };
                
                document.getElementById('btn-modal-save').onclick = async () => {
                    const name = document.getElementById('save-name-input').value;
                    if(!name) return;
                    const existing = await db.get('diagrams', name);
                    if(existing && !(await this.confirm(`Overwrite "${name}"?`))) return;
                    await db.put('diagrams', { name, content: editor.value, timestamp: new Date() });
                    this.state.docName = name;
                    this.toast(`Saved "${name}"`);
                    this.loadStorageList();
                };
                
                document.getElementById('btn-export-db').onclick = async () => {
                    const txt = await db.exportAll();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([txt],{type:'application/json'}));
                    a.download = 'puml_db.json';
                    a.click();
                    this.toast("Database Exported");
                };
                document.getElementById('btn-import-db').onclick = () => document.getElementById('import-db-file').click();
                document.getElementById('import-db-file').onchange = async (e) => {
                    if(e.target.files[0] && await db.importAll(await e.target.files[0].text())) {
                        this.toast("Database Imported"); this.loadStorageList(); this.renderServices();
                    }
                };

                document.getElementById('btn-copy-source').onclick = () => { navigator.clipboard.writeText(editor.value); this.toast("Source Copied"); };
                document.getElementById('btn-dl-source').onclick = () => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([editor.value],{type:'text/plain'}));
                    const safeName = this.state.docName.replace(/[^a-z0-9_\-\.]/gi, '_');
                    a.download = `${safeName}.puml`;
                    a.click();
                    this.toast("Downloaded Source");
                };
                document.getElementById('file-upload').onchange = async (e) => {
                    if(e.target.files[0]) { editor.value = await e.target.files[0].text(); this.update(); this.toast("File Loaded"); }
                };

                // Service Modal
                const chkAuth = document.getElementById('chk-svc-auth');
                const inpToken = document.getElementById('svc-token');
                chkAuth.onchange = () => { if(chkAuth.checked) inpToken.classList.remove('hidden'); else inpToken.classList.add('hidden'); };

                document.getElementById('btn-svc-save').onclick = async () => {
                    const name = document.getElementById('svc-name').value;
                    const url = document.getElementById('svc-url').value;
                    
                    if(chkAuth.checked && !inpToken.value.trim()) {
                        this.toast("Token required if checked!");
                        return;
                    }
                    
                    const token = chkAuth.checked ? inpToken.value : null;
                    if(name && url) { await db.put('services', {name, url, token}); this.openServicesModal(); this.renderServices(); this.toast("Service Saved"); }
                };
                document.getElementById('btn-svc-clear').onclick = () => { 
                    document.getElementById('svc-name').value = ''; document.getElementById('svc-url').value = ''; 
                    inpToken.value=''; chkAuth.checked=false; inpToken.classList.add('hidden');
                };
                document.getElementById('btn-svc-reset-defaults').onclick = async () => {
                    await db.put('services', { name: 'PlantUML (Online)', url: 'https://www.plantuml.com/plantuml' });
                    await db.put('services', { name: 'Local (Port 8080)', url: 'http://127.0.0.1:8080/plantuml' });
                    this.openServicesModal(); this.renderServices(); this.toast("Services Reset");
                };
                
                document.getElementById('btn-svc-export').onclick = async () => {
                    const services = await db.getAll('services');
                    const txt = JSON.stringify(services, null, 2);
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([txt],{type:'application/json'}));
                    a.download = 'puml_services.json';
                    a.click();
                };
                document.getElementById('btn-svc-import').onclick = () => document.getElementById('import-svc-file').click();
                document.getElementById('import-svc-file').onchange = async (e) => {
                    if(e.target.files[0]) {
                        try {
                            const svcs = JSON.parse(await e.target.files[0].text());
                            if(Array.isArray(svcs)) {
                                for(let s of svcs) await db.put('services', s);
                                this.openServicesModal(); this.renderServices(); this.toast("Services Imported");
                            }
                        } catch(e) { alert("Invalid JSON"); }
                    }
                };
            },
            
            saveConfig() {
                db.put('config', { key:'settings', svcUrl: this.state.svcUrl, previewFmt: this.state.previewFmt });
            },

            async prompt(title, val='') {
                return new Promise(res => {
                    const m = document.getElementById('modal-input');
                    const inp = document.getElementById('input-val');
                    document.getElementById('input-title').textContent = title;
                    inp.value = val;
                    m.classList.add('active');
                    inp.focus();
                    const ok = () => { m.classList.remove('active'); cleanup(); res(inp.value); };
                    const cancel = () => { m.classList.remove('active'); cleanup(); res(null); };
                    document.getElementById('btn-input-ok').onclick = ok;
                    document.getElementById('btn-input-cancel').onclick = cancel;
                    const cleanup = () => { document.getElementById('btn-input-ok').onclick = null; document.getElementById('btn-input-cancel').onclick = null; inp.onkeydown = null; }
                    inp.onkeydown = (e) => { if(e.key === 'Enter') ok(); if(e.key==='Escape') cancel(); };
                });
            },

            async confirm(msg) {
                return new Promise(res => {
                    const m = document.getElementById('modal-confirm');
                    document.getElementById('confirm-msg').textContent = msg;
                    m.classList.add('active');
                    document.getElementById('btn-confirm-yes').onclick = () => { m.classList.remove('active'); res(true); };
                    document.getElementById('btn-confirm-no').onclick = () => { m.classList.remove('active'); res(false); };
                });
            },

            async update() {
                const txt = document.getElementById('editor').value;
                this.state.encoded = PlantEncoder.encode(txt);
                const fmt = this.state.previewFmt;
                const url = `${this.state.svcUrl}/${fmt}/${this.state.encoded}`;
                const container = document.getElementById('preview-content');

                // Cleanup previous blob if any
                if(this.state.currentPreviewBlobUrl) {
                    URL.revokeObjectURL(this.state.currentPreviewBlobUrl);
                    this.state.currentPreviewBlobUrl = null;
                }

                if (fmt === 'txt') {
                    // Fallback to Iframe for ASCII to avoid CORS if fetch fails
                    container.innerHTML = `<iframe src="${url}"></iframe>`;
                } else if (fmt === 'svg') {
                     // Check if Auth is needed (token present)
                     const svcs = await db.getAll('services');
                     const currSvc = svcs.find(s => this.state.svcUrl.startsWith(s.url));
                     const needsAuth = currSvc && currSvc.token;

                     if (needsAuth) {
                         try {
                            const blob = await this.getOutputBlob(fmt);
                            const svgText = await blob.text();
                            if(svgText.trim().startsWith('<svg')) container.innerHTML = svgText;
                            else {
                                 const bUrl = URL.createObjectURL(blob);
                                 this.state.currentPreviewBlobUrl = bUrl;
                                 container.innerHTML = `<img src="${bUrl}" alt="Diagram">`;
                            }
                        } catch(e) { 
                             container.innerHTML = `<div style="padding:20px; color:red;">Error loading SVG (Auth): ${e}</div>`;
                        }
                     } else {
                         // No Auth -> Use direct IMG SRC to bypass CORS
                         container.innerHTML = `<img src="${url}" alt="Diagram">`;
                     }
                } else { 
                    // PNG
                    const svcs = await db.getAll('services');
                    const currSvc = svcs.find(s => this.state.svcUrl.startsWith(s.url));
                    const needsAuth = currSvc && currSvc.token;

                    if (needsAuth) {
                        try {
                            const blob = await this.getOutputBlob(fmt);
                            const bUrl = URL.createObjectURL(blob);
                            this.state.currentPreviewBlobUrl = bUrl;
                            container.innerHTML = `<img src="${bUrl}" alt="Diagram">`;
                        } catch(e) {
                            container.innerHTML = `<div style="padding:20px; color:red;">Error loading PNG (Auth): ${e}</div>`;
                        }
                    } else {
                        container.innerHTML = `<img src="${url}" alt="Diagram">`;
                    }
                }
            },
            
            async handleCopy(fmt) {
                try {
                    const blob = await this.getOutputBlob(fmt);
                    if(fmt === 'txt' || fmt === 'svg') {
                        await navigator.clipboard.writeText(await blob.text());
                    } else {
                        await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
                    }
                    this.toast("Copied");
                } catch(e) { alert("Copy failed (CORS Restricted): " + e.message); }
            },
            
            async handleDownload(fmt) {
                try {
                    const blob = await this.getOutputBlob(fmt);
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    const safeName = this.state.docName.replace(/[^a-z0-9_\-\.]/gi, '_');
                    a.download = `${safeName}.${fmt}`;
                    a.click();
                    this.toast("Downloaded");
                } catch(e) { 
                    // Fallback to direct link for CORS issues
                    const safeName = this.state.docName.replace(/[^a-z0-9_\-\.]/gi, '_');
                    const url = `${this.state.svcUrl}/${fmt === 'svg-image' ? 'svg' : fmt}/${this.state.encoded}`;
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${safeName}.${fmt}`;
                    a.target = '_blank';
                    a.click();
                    this.toast("Download Started (Fallback)");
                }
            },
            
            async getOutputBlob(fmt) {
                const reqFmt = (fmt === 'svg-image' ? 'svg' : fmt);
                const url = `${this.state.svcUrl}/${reqFmt}/${this.state.encoded}`;
                
                // If special handling for svg-image/png rasterization from DOM
                const svg = document.querySelector('#preview-content svg');
                if(fmt === 'png' && svg) {
                    return new Promise((res, rej) => {
                        const cvs = document.createElement('canvas');
                        const img = new Image();
                        const xml = new XMLSerializer().serializeToString(svg);
                        img.onload = () => {
                            cvs.width = img.width; cvs.height = img.height;
                            const ctx = cvs.getContext('2d');
                            ctx.fillStyle='white'; ctx.fillRect(0,0,cvs.width,cvs.height);
                            ctx.drawImage(img,0,0);
                            cvs.toBlob(res, 'image/png');
                        };
                        img.onerror = rej;
                        img.src = 'data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(xml)));
                    });
                }
                if (fmt === 'svg-image' && svg) {
                     const xml = new XMLSerializer().serializeToString(svg);
                     return new Blob([xml], {type: 'image/svg+xml'});
                }
                
                // Fetch logic with Auth
                const svcs = await db.getAll('services');
                const currSvc = svcs.find(s => this.state.svcUrl.startsWith(s.url));
                const opts = { credentials: 'omit' }; // Privacy: No cookies
                
                if(currSvc && currSvc.token) {
                    opts.headers = { 'Authorization': 'Bearer ' + currSvc.token };
                }

                const r = await fetch(url, opts);
                if(!r.ok) throw new Error("Network error: " + r.status);
                return await r.blob();
            },

            async loadStorageList() {
                const list = document.getElementById('diagram-list');
                list.innerHTML = '';
                (await db.getAll('diagrams')).forEach(d => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span><b>${d.name}</b></span>`;
                    const div = document.createElement('div');
                    div.className = 'flex-row';
                    const btnLoad = document.createElement('button'); btnLoad.textContent = 'Load';
                    btnLoad.onclick = () => { 
                        document.getElementById('editor').value = d.content; 
                        document.getElementById('save-name-input').value = d.name;
                        this.state.docName = d.name;
                        this.update(); 
                        document.querySelector('#modal-storage').classList.remove('active'); 
                        this.toast("Loaded");
                    };
                    const btnRen = document.createElement('button'); btnRen.textContent = 'Rename';
                    btnRen.onclick = async () => {
                        const n = await this.prompt("New Name:", d.name);
                        if(n && n!==d.name) { 
                            await db.delete('diagrams',d.name); d.name=n; await db.put('diagrams',d); 
                            this.loadStorageList(); this.toast("Renamed");
                        }
                    };
                    const btnDel = document.createElement('button'); btnDel.textContent = '✕'; btnDel.className='danger';
                    btnDel.onclick = async () => { if(await this.confirm('Delete?')) { await db.delete('diagrams',d.name); this.loadStorageList(); this.toast("Deleted"); } };
                    div.append(btnLoad, btnRen, btnDel); li.append(div); list.append(li);
                });
            },
            
            async openServicesModal() {
                const list = document.getElementById('service-list'); list.innerHTML = '';
                (await db.getAll('services')).forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span><b>${s.name}</b><br><small>${s.url}</small></span>`;
                    const div = document.createElement('div'); div.className='flex-row';
                    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit';
                    btnEdit.onclick = () => { 
                        document.getElementById('svc-name').value=s.name; document.getElementById('svc-url').value=s.url; 
                        const hasTok = !!s.token;
                        document.getElementById('chk-svc-auth').checked = hasTok;
                        const tInp = document.getElementById('svc-token');
                        tInp.value = s.token || '';
                        if(hasTok) tInp.classList.remove('hidden'); else tInp.classList.add('hidden');
                    };
                    const btnDel = document.createElement('button'); btnDel.textContent='✕'; btnDel.className='danger';
                    btnDel.onclick = async () => { if(await this.confirm('Delete?')) { await db.delete('services', s.name); this.openServicesModal(); this.renderServices(); this.toast("Service Removed"); }};
                    div.append(btnEdit, btnDel); li.append(div); list.append(li);
                });
                document.getElementById('modal-services').classList.add('active');
            },
            
            toast(m) { 
                const t=document.getElementById('toast'); 
                t.textContent=m; 
                t.classList.add('show'); 
                setTimeout(()=>t.classList.remove('show'), 2000); 
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
